name: Go Multi-Platform Build (Manual)

on:
  workflow_dispatch:
    inputs:
      go_version:
        description: 'Go version to use'
        required: false
        default: '1.20'

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Print Environment Variables  # 添加这一步来调试
      run: |
        echo "GOOS: $GOOS"
        echo "GOARCH: $GOARCH"
        go env
        env
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ github.event.inputs.go_version || '1.20' }}

    - name: Build
      working-directory: ./go  # 设置工作目录为 ./go
      run: go build -v -o ../r2img_${{ matrix.os }}_${{ github.event.inputs.go_version || '1.20' }} cmd/main.go
      # 注意输出路径的调整：因为我们在 ./go 目录下，所以输出到上一级目录
      env:
        GOOS: ${{ runner.os }} #这行可以去掉

    - name: Upload artifacts (optional)
      uses: actions/upload-artifact@v4
      with:
        name: r2img-${{ matrix.os }}-${{ github.event.inputs.go_version || '1.20' }}
        path: r2img_${{ matrix.os }}_${{ github.event.inputs.go_version || '1.20' }}
        # 注意：如果这里不指定 working-directory, artifact的path要根据实际情况调整.
